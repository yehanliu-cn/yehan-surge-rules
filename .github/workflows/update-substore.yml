name: Update Sub-Store Subscription

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  substore:
    runs-on: ubuntu-latest

    # Tell Docker CLI to talk to the DinD daemon
    env:
      DOCKER_HOST: tcp://localhost:2375

    services:
      docker:
        image: docker:24.0.5-dind
        # 下面的 options 是 docker run 启动 dind 容器时要加的 flag
        options: >-
          --privileged
          -p 2375:2375
          -p 3000:3000
        env:
          # Disable TLS so it just listens on TCP
          DOCKER_TLS_CERTDIR: ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare folders
        run: |
          mkdir -p source/custom/Advertising
          mkdir -p output

      - name: Start Sub‑Store container
        run: |
          docker pull sub-store-org/sub-store:latest
          docker rm -f substore || true
          docker run -d --name substore \
            -v "${{ github.workspace }}/source/custom/Advertising/subscriptions.list:/ssm/config/subscriptions.list" \
            sub-store-org/sub-store:latest

      - name: Wait for Sub‑Store startup
        run: sleep 15

      - name: Download Surge subscription
        run: |
          curl -sSL http://localhost:3000/subscription/surge \
            -o output/substore.list
          echo "▶ Preview:"
          head -n5 output/substore.list

      - name: Commit & Push substore.list
        uses: EndBug/add-and-commit@v9
        with:
          message: chore: update substore.list
          add: output/substore.list
