name: 更新多机场订阅

on:
  workflow_dispatch:
  push:
    paths:
      - 'source/custom/Advertising/subscriptions.list'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取仓库代码，并保留凭据以便后续推回
      - name: Checkout 仓库
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      # 2. 安装 Node.js 环境
      - name: 设置 Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 3. 安装 Sub-Store CLI
      - name: 安装 Sub‑Store
        run: npm install -g @sub-store/cli

      # 4. 合并 subscriptions.list 中的所有订阅成一个 Surge 配置
      - name: 生成 substore.conf
        run: |
          mkdir -p output
          sub-store build \
            --input source/custom/Advertising/subscriptions.list \
            --target Surge \
            --output output/substore.conf

      # 5. 显示前几行，确认文件内容
      - name: 预览 output/substore.conf
        run: head -n 10 output/substore.conf

      # 6. 提交并推送回仓库
      - name: Commit & Push substore.conf
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ci: 更新合并后的多机场订阅"
          file_pattern: "output/substore.conf"
