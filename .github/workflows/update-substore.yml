# .github/workflows/substore.yml
name: Build & Deploy Sub-Store Subscription

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  substore:
    runs-on: ubuntu-latest
    # 声明 DinD 服务
    services:
      docker:
        image: docker:24.0.5-dind
        privileged: true
        # 暴露 Docker API 端口 2375，和 Sub-Store 的 3000
        ports:
          - 2375:2375
          - 3000:3000

    env:
      # 指向上面声明的 DinD 服务
      DOCKER_HOST: tcp://localhost:2375
      DOCKER_TLS_VERIFY: "0"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare subscriptions.list
        run: |
          # 你的机场订阅源文件路径
          mkdir -p source/custom/Advertising
          # 确保你的 subscriptions.list 放在这里：
          # source/custom/Advertising/subscriptions.list
          ls -lah source/custom/Advertising

      - name: Launch Sub-Store container
        run: |
          # 这里用官方 sub-store 镜像，替换成最新 tag
          docker pull sub-store-org/sub-store:latest
          docker rm -f substore || true
          docker run -d \
            --name substore \
            -p 3000:3000 \
            -v $PWD/source/custom/Advertising/subscriptions.list:/ssm/config/subscriptions.list \
            sub-store-org/sub-store:latest

      - name: Wait for Sub-Store to be ready
        run: sleep 15

      - name: Download generated Surge subscription
        run: |
          curl -sSL http://localhost:3000/subscription/surge -o output/substore.list
          echo "=> output/substore.list:"
          head -n5 output/substore.list

      - name: Commit & Push substore.list
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore: update substore.list"
          add: "output/substore.list"
