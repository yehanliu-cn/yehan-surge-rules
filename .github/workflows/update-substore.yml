# .github/workflows/subscription.yml
name: Build & Deploy Subscriptions

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Docker (needed for Sub-Store)
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io

      - name: Install Sub-Store-Manager-Cli
        run: |
          curl -sSL https://sub-store-org.github.io/resource/ssm/install.sh | bash

      - name: Start Sub-Store (headless)
        run: |
          ssm new --name mysub --port 3000
          # 把你的 subscriptions.list 复制到容器挂载目录
          mkdir -p ~/.ssm/mysub/config
          cp source/custom/Advertising/subscriptions.list ~/.ssm/mysub/config/
          ssm start --name mysub

      - name: Wait for Sub-Store to merge
        run: sleep 30

      - name: Download generated Surge rules
        run: |
          curl -sSL http://localhost:3000/subscription/surge > output/substore.list

      - name: Commit & Push new substore.list
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore: update substore.list"
          add: "output/substore.list"
