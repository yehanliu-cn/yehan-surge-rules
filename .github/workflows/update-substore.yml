name: Update Sub-Store Subscription

# æ‰‹åŠ¨æˆ– push åˆ° master æ—¶è§¦å‘
on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  substore:
    runs-on: ubuntu-latest

    # ä½¿ç”¨ DinDï¼ˆDockerâ€‘inâ€‘Dockerï¼‰æœåŠ¡å¯åŠ¨ Subâ€‘Store
    services:
      docker:
        image: docker:24.0.5-dind
        # è¿™é‡ŒæŠŠ privileged æ”¾åˆ° options é‡Œ
        options: >-
          --privileged
          -p 2375:2375
          -p 3000:3000
        # ç¦ç”¨ TLSï¼Œå¦åˆ™éœ€è¦æ›´å¤šé…ç½®
        env:
          DOCKER_TLS_CERTDIR: ""

    # å‘Šè¯‰ Docker CLI å»å“ªé‡Œæ‰¾å®ˆæŠ¤è¿›ç¨‹
    env:
      DOCKER_HOST: tcp://localhost:2375

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Ensure directories exist
        run: |
          mkdir -p source/custom/Advertising
          mkdir -p output

      - name: Launch Sub-Store container
        run: |
          # æ‹‰å–å®˜æ–¹é•œåƒï¼ˆè¯·æ ¹æ®å®é™…å®˜æ–¹ä»“åº“å’Œ Tag è°ƒæ•´ï¼‰
          docker pull sub-store-org/sub-store:latest
          # å¦‚æœæœ‰åŒåæ—§å®¹å™¨å°±å…ˆåˆ æ‰
          docker rm -f substore || true
          # å¯åŠ¨ï¼Œå¹¶æŒ‚è½½ä½ çš„æœºåœºè®¢é˜…æ–‡ä»¶
          docker run -d --name substore \
            -v "${{ github.workspace }}/source/custom/Advertising/subscriptions.list:/ssm/config/subscriptions.list" \
            sub-store-org/sub-store:latest

      - name: Wait for Sub-Store to be ready
        run: sleep 15

      - name: Download Surge subscription
        run: |
          curl -sSL http://localhost:3000/subscription/surge \
            -o output/substore.list
          echo "ğŸ‘‰ output/substore.list (first 5 lines):"
          head -n5 output/substore.list

      - name: Commit & Push updated subscription
        uses: EndBug/add-and-commit@v9
        with:
          message: chore: update substore.list
          add: output/substore.list
